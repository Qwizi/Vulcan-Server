{% extends "layout.html" %}

{% block body %}
<div class="uk-section">
    <div class="uk-container uk-section-muted uk-flex uk-flex-column" >

        <div class="uk-card uk-card-default uk-card-hover uk-margin">
            <div class="uk-card-header">
                ZarzÄ…dzaj klientem {{client}}
            </div>
            <div class="uk-card-body">
                <div class="flex-inline">
                    <div class="uk-margin">
                        <button class="uk-button uk-button-primary" id="manageBtnScreenShoot">Zrzut ekranu</button>
                    </div>
                </div>
                <div class="flex">
                    <div class="uk-margin">
                        {% include "website_form.html" %}
                    </div>
                    <div class="uk-margin">
                        {% include "command_form.html" %}
                        <div class="uk-card uk-card-secondary uk-card-hover uk-margin uk-dark">
                            <div class="uk-card-header">Wynik</div>
                            <div id="commandResult" class="uk-card-body"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="uk-card uk-card-default uk-card-hover uk-margin">
            <div class="uk-card-header">
                Informacje
            </div>
            <div class="uk-card-body">
                <ul uk-tab>
                    <li><a href="#">System</a></li>
                    <li><a href="#">CPU</a></li>
                    <li><a href="#">GPU</a></li>
                    <li><a href="#">Dyski</a></li>
                </ul>

                <ul class="uk-switcher uk-margin">
                    <li>
                        <div uk-spinner class="systemSpinner"></div>
                       <div id="osInfo"></div>
                    </li>
                    <li>
                        <div uk-spinner class="systemSpinner"></div>
                        <div id="cpuInfo"></div>
                    </li>
                    <li>
                        <div uk-spinner class="systemSpinner"></div>
                        <div id="gpuInfo"></div>
                    </li>
                    <li>
                        <div uk-spinner class="systemSpinner"></div>
                        <div id="diskInfo"></div>
                    </li>
                </ul>
            </div>
        </div>
        <div class="uk-card uk-card-default uk-card-hover uk-margin">
            <div class="uk-card-header">
                Ostatnie 5 zrzutow ekranu
            </div>
            <div class="uk-card-body">
                <div class="uk-child-width-1-3@m" uk-grid uk-lightbox="animation: slide">
                    <div>
                        <a class="uk-inline" href="/src/public/screenshoots/08c3f5d1-e1ee-4edb-890b-937a87805403.png" data-caption="Caption 1">
                            <img src="/src/public/screenshoots/08c3f5d1-e1ee-4edb-890b-937a87805403.png" alt="">
                        </a>
                    </div>
                    <div>
                        <a class="uk-inline" href="/src/public/screenshoots/85587137-241e-4c8a-8498-a36a6efee7ef.png" data-caption="Caption 2">
                            <img src="/src/public/screenshoots/85587137-241e-4c8a-8498-a36a6efee7ef.png" alt="">
                        </a>
                    </div>
                    <div>
                        <a class="uk-inline" href="/src/public/screenshoots/a1f58af7-e214-424f-b46f-db731720079a.png" data-caption="Caption 3">
                            <img src="/src/public/screenshoots/a1f58af7-e214-424f-b46f-db731720079a.png" alt="">
                        </a>
                    </div>
                    <div>
                        <a class="uk-inline" href="/src/public/screenshoots/a1f58af7-e214-424f-b46f-db731720079a.png" data-caption="Caption 3">
                            <img src="/src/public/screenshoots/a1f58af7-e214-424f-b46f-db731720079a.png" alt="">
                        </a>
                    </div>
                    <div>
                        <a class="uk-inline" href="/src/public/screenshoots/a1f58af7-e214-424f-b46f-db731720079a.png" data-caption="Caption 3">
                            <img src="/src/public/screenshoots/a1f58af7-e214-424f-b46f-db731720079a.png" alt="">
                        </a>
                    </div>
                    <div>
                        <a class="uk-inline" href="/src/public/screenshoots/a1f58af7-e214-424f-b46f-db731720079a.png" data-caption="Caption 3">
                            <img src="/src/public/screenshoots/a1f58af7-e214-424f-b46f-db731720079a.png" alt="">
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}


{% block js %}
<script>
    const clientId = "{{ client }}";
    const hideSpinners = () => {
        const systemSpinner = document.querySelectorAll(".systemSpinner");
        for (let i=0; i < systemSpinner.length; i++) {
            systemSpinner[i].style.display = 'none';
        }
    }

    const parseData = (el, data, multi=false) => {
        let htmlData = '';
        if (multi) {
            data.map(item => {
                for (const [key, value] of Object.entries(item)) {
                    htmlData += `${key}: ${value}` + "<br>";
                }
            })
        } else {
            for (const [key, value] of Object.entries(data)) {
                htmlData += `${key}: ${value}` + "<br>";
            }
        }

        el.innerHTML = htmlData;
    }

    const generateSystemInfo =  (data) => {
        const osInfo = document.getElementById('osInfo');
        const cpuInfo = document.getElementById('cpuInfo');
        const gpuInfo = document.getElementById('gpuInfo');
        const diskInfo = document.getElementById('diskInfo');
        hideSpinners();

        const osData = data.os;
        const cpuData = data.cpu;
        const gpuData = data.gpu;
        const diskData = data.disk;

        parseData(osInfo, osData);
        parseData(cpuInfo, cpuData);
        parseData(gpuInfo, gpuData, true);
        parseData(diskInfo, diskData, true);
    }
    //const osInfoFromLS = JSON.parse(localStorage.getItem('systemInfo'));
    (async () => {
        const clientData = await findClientInLocalStorage(clientId);
        if (!clientData) {
            await addClientToLocalStorage(clientId);
            sio.emit('getSystemInfoFromClient', {clientId: clientId});
        }
        else
        {
            if (Object.keys(clientData.details).length === 0) {
                sio.emit('getSystemInfoFromClient', {clientId: clientId});
            }
            else
            {
                generateSystemInfo(clientData.details);
            }
        }
        console.log(clientData);
    })();

    const getFormData  = (target) => {
        const formData = new FormData(target)
        let data = {};
        Array.from(formData).map((item) => {
            data[item[0]] = item[1]
        })
        data.clientId = clientId;
        return data;
    }

    const manageBtnScreenShoot = document.getElementById('manageBtnScreenShoot');
    const websiteForm = document.getElementById('websiteForm')
    const websiteFormBtn = document.getElementById('websiteFormBtn');
    const urlSpinner = document.getElementById('urlSpinner')
    const urlInput = document.querySelector('input[name="url"]')
    const commandForm = document.getElementById('commandForm');
    const commandFormBtn = document.getElementById('commandFormBtn');
    const commandResult = document.getElementById('commandResult');
    const commandSpinner = document.getElementById('commandSpinner');

    manageBtnScreenShoot.addEventListener('click', (e) => {
        sio.emit('screenshoot', {clientId: clientId});
    })

    websiteForm.addEventListener('submit', (e) => {
        e.preventDefault();
        console.log('Strona!')
        const data = getFormData(e.target);
        sio.emit('website', data)
    })

    commandForm.addEventListener('submit', (e) => {
        e.preventDefault();
        console.log('Komenda');
        const data = getFormData(e.target);
        sio.emit('command', data);
    })

    sio.on('systemInfo', function(data) {
        (async () => {
            await updateClientDetailsLocalStorage(clientId, data);
            generateSystemInfo(data);
        })();
    })

    sio.on('website_btn', function(data) {
        const state = data.state;

        if (!state) {
            websiteFormBtn.disabled = true;
            urlSpinner.style.display = 'block';
            urlInput.value = '';
            urlInput.disabled = true;
        } else {
            websiteFormBtn.disabled = false;
            urlSpinner.style.display = 'none';
            urlInput.disabled = false;
        }

    })

    sio.on('ss_btn', function(data) {
        const state = data.state;

        if (!state) {
            manageBtnScreenShoot.disabled = true;
        } else {
            manageBtnScreenShoot.disabled = false;
            UIkit.notification({message: 'Pomyslnie zrobiono zrzut ekranu', pos: 'bottom-right', status: 'success'})
        }

    })

    sio.on('command', (data) => {
        console.log(data.message);
        commandResult.textContent = data.message;
    })
</script>
{% endblock %}